---
title: "Data"
output: 
   html_document:
     toc: true
     toc_float:
       collapsed: false
     includes:
       after_body: footerEA.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA, message=FALSE, warning=FALSE)
library(JMbayes)
library(lattice)
library(splines)
library(survminer)
```

The pbc2 and pbc2.id data sets are used from the <code>JMbayes</code> package in <code>R</code>. 
The long format data set is called <code>pbc2</code>: 
```{r}
head(pbc2)
```

The wide format data set is called <code>pbc2.id</code>. 
```{r}
head(pbc2.id)
```

# Longitudinal outcome

```{r}
p1 <- xyplot(serBilir ~ year, groups = id, 
             data = pbc2[pbc2$status %in% c("dead", "transplanted"), ], 
             col = "grey", lwd = 1, type = "l",
             ylab = list(label = "Serum Bilirubin", cex = 1.2), ylim=c(0, 41), xlim = c(0, 12.5),
             xlab = list(label = "Years", cex = 1.2),
             main = list(label = "Dead or transplanted patients", cex = 1.04),
             panel = function(x, y,...) {
                 panel.xyplot(x, y, ...)
                 panel.xyplot(pbc2$year[pbc2$status %in% c("dead", "transplanted")], 
                              pbc2$serBilir[pbc2$status %in% c("dead", "transplanted")], 
                              col = 1, lwd = 3, type = "smooth")
       })

p2 <- xyplot(serBilir ~ year, groups = id, 
             data = pbc2[pbc2$status %in% c("alive"), ], 
             col = "grey", lwd = 1, type = "l",
             ylab = list(label = "Serum Bilirubin", cex = 1.2), ylim=c(0, 41), xlim = c(0, 12.5),
             xlab = list(label = "Years", cex = 1.2),
             main = list(label = "Alive patients", cex = 1.04),
             panel = function(x, y,...) {
                 panel.xyplot(x, y, ...)
                 panel.xyplot(pbc2$year[pbc2$status %in% c("alive")], 
                              pbc2$serBilir[pbc2$status %in% c("alive")], 
                              col = 1, lwd = 3, type = "smooth")
       })

print(p1, split = c(1, 1, 2, 1), more = TRUE)
print(p2, split = c(2, 1, 2, 1))
```


```{r}
fit_linear <- lme(serBilir ~ year, random = ~ year | id, data = pbc2)
fit_nonlinear <- lme(serBilir ~ ns(year, 3), random = list(id = pdDiag(form = ~ ns(year, 3))), data = pbc2)

pbc2$fitted_linear <- fitted(fit_linear)
pbc2$fitted_nonlinear <- fitted(fit_nonlinear)

newdata <- pbc2[pbc2$id %in% c(128, 142, 46, 57, 216, 93, 114, 120, 294), ]

xyplot(serBilir ~ year | id, data = newdata, pch = 20, 
       subscripts = TRUE, col = 1, lwd = 3, strip = FALSE, cex = 1.5,
       ylab = list(label = "Serum Bilirubin", cex = 1.2),
       xlab = list(label = "Years", cex = 1.2),
       panel = function(x, y, subscripts = subscripts,...) {
         panel.xyplot(x, y, subscripts = subscripts, ...)
         panel.lines(newdata$year[subscripts], newdata$fitted_linear[subscripts], 
                     col = "red", lwd = 4, lty = 1)
         panel.lines(newdata$year[subscripts], newdata$fitted_nonlinear[subscripts], 
                     col = "blue", lwd = 4, lty = 2)
})
```

# Survival outcome

```{r}
fit <- survfit(Surv(years, status2) ~ 1, data = pbc2.id)
ggsurvplot(fit, data = pbc2.id, risk.table = TRUE, palette = "black", legend = "none")
```

