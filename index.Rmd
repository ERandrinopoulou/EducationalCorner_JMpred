---
title: "Dynamic prediction using joint models of longitudinal and time-to-event data"
author: "Eleni-Rosalina Andrinopoulou, Department of Biostatistics, Erasmus Medical Center"
date: "`r Sys.setenv(LANG = 'en_US.UTF-8'); format(Sys.Date(), '%d %B %Y')`"
output: 
   html_document:
     toc: true
     toc_float:
       collapsed: false
     includes:
         after_body: footerEA.html
---

<span style="color:red; font-weight:bold; font-size:4em;"> Under construction </span>


In this webpage, we describe and show the analysis that was performed in the manuscipt: _Dynamic prediction using joint models of longitudinal and time-to-event data_

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA, message=FALSE, warning=FALSE)
library(JMbayes)
library(lattice)
library(splines)
library(effects)
```

# Packages 

The <code>R</code> packages and versions that are used cen be seen below:

```{r packages2, results='asis', echo=FALSE}
library(dplyr)
library(kableExtra)
library(gifski)
x <- c("JMbayes", "lattice", "splines", "effects")
Rpack <- lapply(x, FUN = function(x) packageVersion(x))
Rpack <- lapply(Rpack, FUN = function(x) as.character(x))
names(Rpack) <- x

Rpack <- data.frame(R = R.Version()$version.string, (Rpack))
colnames(Rpack)[1] <- "**Software**:"

kable(t(Rpack),  caption = "", format = "html") %>%
column_spec(1, width = c("7em")) %>%
column_spec(2, width = c("15em"))
```

\

# Analysis
A first imporant step is to investigate the data set. More details can be found in the tab **Data**.

## Fit a joint model

A mixed-effects submodel can be fitted using the <code>lme</code> function as:
```{r, cache=TRUE}
fit_nonlinear2 <- lme(log(serBilir) ~ ns(year, 3) + age + sex + drug, 
                      random = list(id = pdDiag(form = ~ ns(year, 3))), 
                      data = pbc2)
```

A survival submodel can be fitted using the <code>coxph</code> function as:
```{r, cache=TRUE}
survFit.pbc <- coxph(Surv(years, status2) ~ age + sex + drug, data = pbc2.id, x = TRUE)
```

Then the joint model can be fitted using the <code>jointModelBayes</code> function as:
```{r, cache=TRUE}
jointFit.pbc <- jointModelBayes(fit_nonlinear2, survFit.pbc, timeVar = "year", 
                                baseHaz = "regression-splines", verbose = FALSE)
summary(jointFit.pbc)
```


In order to visualize
```{r, cache=TRUE}
ef <- Effect(c("year", "drug"), fit_nonlinear2, typical=mean, given.values=c(sexfemale=1))

trellis.par.set(strip.background=list(col="lightgrey"))

plot(ef, ylab = list("log serum bilirubin", cex = 1.2), xlab = list("Year", cex = 1.2), 
     rug = FALSE, colors = 1, lwd = 2, grid = TRUE, main = "")
```


## Obtain dynamic predictions
```{r, cache=TRUE}
newdata_5 <- pbc2[pbc2$id == 5, ]

survRes_5 <- list()
for (o in 1:dim(newdata_5)[1]) {
  newdataDyn_5 <- newdata_5[1:o, ]
  survRes_5[[o]] <- survfitJM(object = jointFit.pbc, newdata = newdataDyn_5, idVar = "id", simulate = TRUE, 
                                      survTimes = NULL, last.time = NULL, M = 200, 
                                      CI.levels = c(0.025, 0.975), scale = 1.6)
 }
```

```{r, cache=TRUE, animation.hook='gifski', fig.show='animate'}
for (i in 1:dim(newdata_5)[1]) {
  plot.survfit.JMbayes(survRes_5[[i]], estimator = "mean", conf.int = TRUE, include.y = TRUE, lwd = 2, col = 1,
                       cex.lab.z = 0.8,
                       ylab2 = "log Serum bilirubin", ylab = "Event-free Probability", xlab = "Year",
                       mgp = c(1.7, 0.5, 0), 
                       main = paste0("Patient ", unique(newdata_5$id), ", Visit ", i))
}   
```


```{r, cache=TRUE}
newdata_15 <- pbc2[pbc2$id == 15, ]

survRes_15 <- list()
for (o in 1:dim(newdata_15)[1]) {
  newdataDyn_15 <- newdata_15[1:o, ]
  survRes_15[[o]] <- survfitJM(object = jointFit.pbc, newdata = newdataDyn_15, idVar = "id", simulate = TRUE, 
                                      survTimes = NULL, last.time = NULL, M = 200, 
                                      CI.levels = c(0.025, 0.975), scale = 1.6)
 }
```

```{r, cache=TRUE, animation.hook='gifski', fig.show='animate'}
for (i in 1:dim(newdata_15)[1]) {
  plot.survfit.JMbayes(survRes_15[[i]], estimator = "mean", conf.int = TRUE, include.y = TRUE, lwd = 2, col = 1,
                       cex.lab.z = 0.8,
                       ylab2 = "log Serum bilirubin", ylab = "Event-free Probability", xlab = "Year",
                       mgp = c(1.7, 0.5, 0),
                       main = paste0("Patient ", unique(newdata_15$id), ", Visit ", i))
}  
```


```{r, cache=TRUE}
newdata_42 <- pbc2[pbc2$id == 42, ]

survRes_42 <- list()
for (o in 1:(dim(newdata_42)[1]-3)) {
  newdataDyn_42 <- newdata_42[1:o, ]
  survRes_42[[o]] <- survfitJM(object = jointFit.pbc, newdata = newdataDyn_42, idVar = "id", simulate = TRUE, 
                                      survTimes = NULL, last.time = NULL, M = 200, 
                                      CI.levels = c(0.025, 0.975), scale = 1.6)
 }
```


```{r, cache=TRUE, animation.hook='gifski', fig.show='animate'}
for (i in 1:(dim(newdata_42)[1]-3)) {
  plot.survfit.JMbayes(survRes_42[[i]], estimator = "mean", conf.int = TRUE, include.y = TRUE, lwd = 2, col = 1,
                       cex.lab.z = 0.8,
                       ylab2 = "log Serum bilirubin", ylab = "Event-free Probability", xlab = "Year",
                       mgp = c(1.7, 0.5, 0),
                       main = paste0("Patient ", unique(newdata_42$id), ", Visit ", i))
}  
```


## Evaluate the predictions